<ng-template let-formArray="control" let-formSchema="schema" let-model="model" [fluentContextGuard]="contextGuard">
  <nz-form-item [ngClass]="formSchema.class">
    <nz-form-label
      *ngIf="formSchema.label"
      [nzSpan]="(helper.label.span | invoke: formSchema.label)!"
      [nzTooltipTitle]="helper.tooltip.content | invoke: formSchema.tooltip"
      [nzTooltipIcon]="(helper.tooltip.icon | invoke: formSchema.tooltip)!"
      [nzNoColon]="!config.colon"
      [style.width]="helper.label.width | invoke: formSchema.label">
      {{ helper.label.content | invoke: formSchema.label }}
    </nz-form-label>

    <nz-form-control>
      <nz-row
        #nzRow
        #config="fluentConfig"
        nz-form
        cdkDropList
        [cdkDropListDisabled]="!formSchema.orderable"
        [class.cdk-drop-list-disabled]="!formSchema.orderable"
        [nzGutter]="formSchema.gutter ?? config.gutter"
        [nzAlign]="formSchema.align!"
        [nzJustify]="formSchema.justify!"
        [nzLayout]="config.layout"
        [ngClass]="formSchema.class"
        [ngStyle]="formSchema.style"
        [fluentBinding]="{ schema: formSchema, control: formArray, model }"
        (cdkDropListDropped)="drop(formArray, $event)">
        <ng-template
          #formColTemplate
          let-schema="schema"
          let-control="control"
          let-model="model"
          let-index="index"
          let-first="first">
          <nz-col
            cdkDrag
            [cdkDragBoundary]="nzRow"
            [nzSpan]="schema.col | col: 'span'"
            [nzFlex]="schema.col | col: 'flex'"
            [nzOffset]="schema.col | col: 'offset'"
            [nzPush]="schema.col | col: 'push'"
            [nzPull]="schema.col | col: 'pull'"
            [nzOrder]="schema.col | col: 'order'"
            [hidden]="schema.hidden | reactive: model:schema:control">
            <fluent-form-col-content-outlet [control]="control" [schema]="schema" [model]="model">
            </fluent-form-col-content-outlet>

            <!-- form array 的 schemas 可能会有多个，只在第一个时渲染移除按钮 -->
            <button
              *ngIf="first && (formSchema.removable ?? true)"
              class="fluent-array-element-remove-btn"
              type="button"
              nz-button
              nzShape="circle"
              nzSize="small"
              [disabled]="formArray.length <= (helper.length.min | invoke: formSchema.length)"
              (click)="formArray.removeAt(index)">
              <span nz-icon nzType="minus" nzTheme="outline"></span>
            </button>
          </nz-col>
        </ng-template>

        <ng-container *ngFor="let control of formArray.controls; index as index">
          <ng-container
            *ngFor="let subschema of formSchema.schemas; first as first"
            [ngTemplateOutlet]="formColTemplate"
            [ngTemplateOutletContext]="{
              control: control,
              schema: subschema,
              model: model,
              index: index,
              first: first
            }">
          </ng-container>
        </ng-container>
      </nz-row>

      <ng-container *ngIf="formSchema.addable ?? true">
        <button
          *ngIf="helper.addable | invoke: formSchema.addable as addable"
          type="button"
          nz-button
          [nzType]="addable.type ?? null"
          [nzBlock]="addable.variants?.block"
          [nzDanger]="addable.variants?.danger"
          [nzGhost]="addable.variants?.ghost"
          [nzShape]="addable.variants?.shape!"
          [nzSize]="addable.size!"
          [disabled]="formArray.length === (helper.length.max | invoke: formSchema.length)"
          (click)="push(formArray, formSchema)">
          <span *ngIf="addable.icon" nz-icon nzTheme="outline" [nzType]="addable.icon"></span>
          <ng-template *ngIf="addable.content" [nzStringTemplateOutlet]="addable.content | template">
            {{ addable.content }}
          </ng-template>
        </button>
      </ng-container>
    </nz-form-control>
  </nz-form-item>
</ng-template>
