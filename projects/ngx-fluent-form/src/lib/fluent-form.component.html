<nz-spin nzTip="Loading..." [nzSpinning]="spinning" nzSize="large">
  <ng-container *ngTemplateOutlet="formTemplate; context: { form: form, schema: schema }"></ng-container>

  <ng-container *ngIf="canSave">
    <nz-divider [style.margin-bottom.px]="12"></nz-divider>
    <div nz-row nzJustify="end" [style.margin-bottom.px]="-3">
      <button nz-button [style.margin-right.px]="12" (click)="onCancel()">取消</button>
      <button nz-button nzType="primary" [disabled]="form.invalid" (click)="onSubmit()">保存</button>
    </div>
  </ng-container>
</nz-spin>

<ng-template #formTemplate let-form="form" let-schema="schema" let-embed="embed">
  <form nz-row [nzGutter]="{ xs: 8, sm: 16, md: 24, lg: 32 }" nz-form [nzLayout]="layout" [nzNoColon]="noColon"
        [formGroup]="form">
    <div *ngIf="!embed && addOnBefore" nz-col>
      <nz-form-item>
        <nz-form-control>
          <ng-container *ngTemplateOutlet="addOnBefore; context: { form: form }"></ng-container>
        </nz-form-control>
      </nz-form-item>
    </div>

    <div *ngFor="let options of schema" nz-col [nzSpan]="options.span">
      <ng-container *ngIf="options.type === 'embed'" [formGroupName]="options.name">
        <!-- <div [style.padding-left.px]="options.type === 'embed' ? 30 : 0"> -->
        <nz-divider [nzText]="options.label"></nz-divider>
        <ng-container
                      *ngTemplateOutlet="formTemplate; context: { form: form.get(options.name), schema: options.schema, embed: true }">
        </ng-container>
        <!-- </div> -->
      </ng-container>

      <nz-form-item *ngIf="options.type !== 'embed'">
        <nz-form-label *ngIf="options.label" [nzRequired]="options.required">{{ options.label }}</nz-form-label>
        <nz-form-control [nzErrorTip]="options.errorTip">
          <ng-container [ngSwitch]="options.type">
            <ng-template #inputTemplate let-options="options">
              <nz-input-group [nzAddOnBefore]="options.before?.template" [nzAddOnAfter]="options.after?.template"
                              [nzAddOnBeforeIcon]="options.before?.icon" [nzAddOnAfterIcon]="options.after?.icon"
                              [nzPrefix]="options.prefix" [nzSuffix]="options.suffix">
                <input #ref [fluentPropertyBinder]="{ host: ref, options: options }"
                       [fluentEventBinder]="{ host: ref, options: options }" nz-input [formControlName]="options.name"
                       [placeholder]="options.placeholder ?? ''" (ngModelChange)="options.change?.($event, options)" />
              </nz-input-group>
            </ng-template>

            <ng-container *ngSwitchCase="'text'">
              <ng-container *ngTemplateOutlet="inputTemplate; context: { options: options }">
              </ng-container>
            </ng-container>

            <ng-container *ngSwitchCase="'email'">
              <ng-container *ngTemplateOutlet="inputTemplate; context: { options: options }">
              </ng-container>
            </ng-container>

            <ng-container *ngSwitchCase="'password'">
              <ng-container *ngTemplateOutlet="inputTemplate; context: { options: options }">
              </ng-container>
            </ng-container>

            <ng-container *ngSwitchCase="'textarea'">
              <textarea #ref [fluentPropertyBinder]="{ host: ref, options: options }"
                        [fluentEventBinder]="{ host: ref, options: options }" nz-input [formControlName]="options.name"
                        [placeholder]="options.placeholder ?? ''" [rows]="options.rows" [nzAutosize]="options.autosize ?? {}"
                        (ngModelChange)="options.change?.($event, options)"></textarea>
            </ng-container>

            <ng-container *ngSwitchCase="'number'">
              <nz-input-number #ref [fluentPropertyBinder]="{ host: ref, options: options }"
                               [fluentEventBinder]="{ host: ref, options: options }" [formControlName]="options.name"
                               [nzPlaceHolder]="options.placeholder" [nzMin]="options.min ?? -infinity"
                               [nzMax]="options.max ?? infinity" [nzPrecision]="options.precision ?? ''"
                               [nzPrecisionMode]="options.precisionMode" [nzStep]="options.step ?? 1"
                               (ngModelChange)="options.change?.($event, options)">
              </nz-input-number>
            </ng-container>

            <ng-container *ngSwitchCase="'date'">
              <nz-date-picker #ref [fluentPropertyBinder]="{ host: ref, options: options }"
                              [fluentEventBinder]="{ host: ref, options: options }" [formControlName]="options.name"
                              [nzPlaceHolder]="options.placeholder" [nzMode]="options.mode" [nzAllowClear]="options.clear"
                              [nzShowTime]="options.showTime" [nzFormat]="options.format" [nzInline]="options.inline"
                              (ngModelChange)="options.change?.($event, options)"></nz-date-picker>
            </ng-container>

            <ng-container *ngSwitchCase="'range'">
              <nz-range-picker #ref [fluentPropertyBinder]="{ host: ref, options: options }"
                               [fluentEventBinder]="{ host: ref, options: options }" [formControlName]="options.name"
                               [nzPlaceHolder]="options.placeholder" [nzMode]="options.mode" [nzAllowClear]="options.clear"
                               [nzShowTime]="options.showTime" [nzFormat]="options.format" [nzInline]="options.inline"
                               (ngModelChange)="options.change?.($event, options)"></nz-range-picker>
            </ng-container>

            <ng-container *ngSwitchCase="'time'">
              <nz-time-picker #ref [fluentPropertyBinder]="{ host: ref, options: options }"
                              [fluentEventBinder]="{ host: ref, options: options }" [formControlName]="options.name"
                              [nzPlaceHolder]="options.placeholder" [nzAllowEmpty]="options.clear"
                              [nzFormat]="options.format ?? 'HH:mm:ss'" [nzHourStep]="options.step?.hour"
                              [nzMinuteStep]="options.step?.minute" [nzSecondStep]="options.step?.second"
                              (ngModelChange)="options.change?.($event, options)">
              </nz-time-picker>
            </ng-container>

            <ng-container *ngSwitchCase="'switch'">
              <nz-switch #ref [fluentPropertyBinder]="{ host: ref, options: options }"
                         [fluentEventBinder]="{ host: ref, options: options }" [formControlName]="options.name"
                         [nzCheckedChildren]="options.placeholder?.[0]" [nzUnCheckedChildren]="options.placeholder?.[1]"
                         (ngModelChange)="options.change?.($event, options)">
              </nz-switch>
            </ng-container>

            <ng-container *ngSwitchCase="'select'">
              <nz-select #ref [fluentPropertyBinder]="{ host: ref, options: options }"
                         [fluentEventBinder]="{ host: ref, options: options }" [formControlName]="options.name"
                         [nzPlaceHolder]="options.placeholder" [nzAllowClear]="options.clear" [nzMode]="options.mode ?? 'default'"
                         [nzMaxMultipleCount]="options.limit ?? 999" [nzShowSearch]="options.search"
                         (ngModelChange)="options.change?.($event, options)">
                <nz-option *ngFor="let option of options.options.data" [nzValue]="option[options.options.value ?? 'value']"
                           [nzLabel]="option[options.options.label ?? 'label']"></nz-option>
              </nz-select>
            </ng-container>

            <ng-container *ngSwitchCase="'cascader'">
              <nz-cascader #ref [fluentPropertyBinder]="{ host: ref, options: options }"
                           [fluentEventBinder]="{ host: ref, options: options }" [formControlName]="options.name"
                           [nzPlaceHolder]="options.placeholder" [nzAllowClear]="options.clear"
                           [nzExpandTrigger]="options.trigger" [nzShowSearch]="options.search" [nzOptions]="options.options.data"
                           [nzLoadData]="options.options.load" [nzValueProperty]="options.options.value ?? 'value'"
                           [nzLabelProperty]="options.options.label ?? 'label'"
                           (ngModelChange)="options.change?.($event, options)">
              </nz-cascader>
            </ng-container>

            <ng-container *ngSwitchCase="'slider'">
              <nz-slider #ref [fluentPropertyBinder]="{ host: ref, options: options }"
                         [fluentEventBinder]="{ host: ref, options: options }" [formControlName]="options.name"
                         [nzIncluded]="options.included" [nzMax]="options.max ?? 100" [nzMin]="options.min"
                         [nzRange]="options.range" [nzStep]="options.step ?? 1"
                         (ngModelChange)="options.change?.($event, options)">
              </nz-slider>
            </ng-container>

            <ng-container *ngSwitchCase="'radio'">
              <nz-radio-group #ref [fluentPropertyBinder]="{ host: ref, options: options }"
                              [fluentEventBinder]="{ host: ref, options: options }" [formControlName]="options.name"
                              [nzButtonStyle]="options.style" (ngModelChange)="options.change?.($event, options)">
                <ng-container *ngFor="let option of options.options.data">
                  <label *ngIf="!options.style" nz-radio [nzValue]="option[options.options.value ?? 'value']">
                    {{ option[options.options.label ?? 'label'] }}
                  </label>
                  <label *ngIf="options.style" nz-radio-button [nzValue]="option[options.options.value ?? 'value']">
                    {{ option[options.options.label ?? 'label'] }}
                  </label>
                </ng-container>
              </nz-radio-group>
            </ng-container>

            <ng-container *ngSwitchCase="'checkbox'">
              <nz-checkbox-group #ref [fluentPropertyBinder]="{ host: ref, options: options }"
                                 [fluentEventBinder]="{ host: ref, options: options }" [formControlName]="options.name"
                                 (ngModelChange)="options.change?.($event, options)">
              </nz-checkbox-group>
            </ng-container>

            <ng-container *ngSwitchCase="'rate'">
              <nz-rate #ref [fluentPropertyBinder]="{ host: ref, options: options }"
                       [fluentEventBinder]="{ host: ref, options: options }" [formControlName]="options.name"
                       [nzAllowClear]="options.clear ?? true" [nzAllowHalf]="options.half" [nzCharacter]="options.character"
                       [nzCount]="options.count ?? 5" [nzTooltips]="options.tooltips ?? []"
                       (ngModelChange)="options.change?.($event, options)"></nz-rate>
            </ng-container>
          </ng-container>
        </nz-form-control>
      </nz-form-item>
    </div>

    <div *ngIf="!embed && addOnAfter" nz-col>
      <nz-form-item>
        <nz-form-control>
          <ng-container *ngTemplateOutlet="addOnAfter; context: { form: form }"></ng-container>
        </nz-form-control>
      </nz-form-item>
    </div>
  </form>
</ng-template>
