<form
  nz-row
  nz-form
  [nzGutter]="gutter"
  [nzLayout]="layout"
  [ngClass]="schema.class"
  [ngStyle]="schema.style"
  [formGroup]="form"
  [fluentBinderSchema]="schema"
  [fluentBinderControl]="form">
  <ng-template #formColTemplate let-schema="schema" let-control="control" let-model="model">
    <div
      nz-col
      [nzSpan]="(schema.col | typeof: 'number') ? schema.col : schema.col?.span"
      [nzOffset]="schema.col?.offset"
      [nzFlex]="schema.col?.flex"
      [hidden]="schema.hidden | call: model:schema:control">
      <ng-container
        [ngTemplateOutlet]="formColContentTemplate"
        [ngTemplateOutletContext]="{ control: control, schema: schema, model: model }">
      </ng-container>
    </div>
  </ng-template>

  <ng-container
    *ngFor="let subschema of schema.schemas"
    [ngTemplateOutlet]="formColTemplate"
    [ngTemplateOutletContext]="{ control: ($any(subschema).name | control: form), schema: subschema, model: model }">
  </ng-container>
</form>

<ng-template #nestFormTemplate let-form="form" let-schema="schema" let-model="model">
  <nz-row
    nz-form
    [nzGutter]="gutter"
    [nzLayout]="layout"
    [ngClass]="schema.class"
    [ngStyle]="schema.style"
    [fluentBinderSchema]="schema"
    [fluentBinderControl]="form">
    <ng-template #formColTemplate let-schema="schema" let-control="control" let-model="model">
      <div
        nz-col
        [nzSpan]="(schema.col | typeof: 'number') ? schema.col : schema.col?.span"
        [nzOffset]="schema.col?.offset"
        [nzFlex]="schema.col?.flex"
        [hidden]="schema.hidden | call: model:schema:control">
        <ng-container
          fluentWithInjector
          [ngTemplateOutlet]="formColContentTemplate"
          [ngTemplateOutletContext]="{ control: control, schema: schema, model: model }">
        </ng-container>
      </div>
    </ng-template>

    <ng-container
      *ngFor="let subschema of schema.schemas"
      [ngTemplateOutlet]="formColTemplate"
      [ngTemplateOutletContext]="{ control: (subschema.name | control: form), schema: subschema, model: model }">
    </ng-container>
  </nz-row>
</ng-template>

<ng-template #formColContentTemplate let-schema="schema" let-control="control" let-model="model">
  <ng-container [ngSwitch]="schema.kind">
    <ng-container *ngSwitchCase="'group'">
      <nz-divider *ngIf="schema.label" [nzText]="schema.label"></nz-divider>
      <ng-container
        fluentWithInjector
        [ngTemplateOutlet]="nestFormTemplate"
        [ngTemplateOutletContext]="{ form: control, schema: schema, model: model[schema.name] }">
      </ng-container>
    </ng-container>

    <ng-container *ngSwitchCase="'array'">
      <nz-divider *ngIf="schema.label" [nzText]="schema.label"></nz-divider>
      <ng-container
        fluentWithInjector
        [ngTemplateOutlet]="nestFormTemplate"
        [ngTemplateOutletContext]="{ form: control, schema: schema, model: model[schema.name] }">
      </ng-container>
    </ng-container>

    <ng-container *ngSwitchCase="'steps'">
      <ng-container
        fluentWithInjector
        [ngTemplateOutlet]="stepsTemplate"
        [ngTemplateOutletContext]="{ control: control, schema: schema, model: model }">
      </ng-container>
    </ng-container>

    <ng-container *ngSwitchCase="'tabset'">
      <ng-container
        fluentWithInjector
        [ngTemplateOutlet]="tabsTemplate"
        [ngTemplateOutletContext]="{ control: control, schema: schema, model: model }">
      </ng-container>
    </ng-container>

    <ng-container *ngSwitchDefault>
      <ng-container
        fluentWithInjector
        [ngTemplateOutlet]="formItemTemplate"
        [ngTemplateOutletContext]="{ control: control, schema: schema, model: model }">
      </ng-container>
    </ng-container>
  </ng-container>
</ng-template>

<ng-template #formItemTemplate let-schema="schema" let-control="control" let-model="model">
  <nz-form-item [ngClass]="schema.class">
    <nz-form-label
      *ngIf="schema.label"
      [nzSpan]="schema.label.span"
      [nzTooltipTitle]="schema.label.tooltip?.title ?? schema.label.tooltip"
      [nzTooltipIcon]="schema.label.tooltip?.icon"
      [nzFor]="schema.id"
      [nzNoColon]="!colon"
      [nzRequired]="schema.required | call: model:schema:control">
      {{ schema.label.value ?? schema.label }}
    </nz-form-label>
    <!-- 在控件被 input-group 包裹的时候，控件状态/提示默认使用的是 input-group 里的第一个控件 -->
    <!-- 如果需要采用 input-group 内其他控件的状态/提示，需要使用 input-group 的 primary 参数明确指定 -->
    <nz-form-control
      *ngIf="
        schema.kind === 'input-group'
          ? (schema.primary ?? schema.schemas[0].name | schema: schema.schemas)
          : schema as currentSchema
      "
      [nzValidateStatus]="
        schema.kind === 'input-group' ? (schema.primary ?? schema.schemas[0].name | control: control) : control
      "
      [nzHasFeedback]="currentSchema.feedback"
      [nzValidatingTip]="currentSchema.tips?.validating"
      [nzSuccessTip]="currentSchema.tips?.success"
      [nzWarningTip]="currentSchema.tips?.warning"
      [nzErrorTip]="currentSchema.tips?.error"
      [nzExtra]="currentSchema.tips?.extra"
      [nzAutoTips]="currentSchema.tips?.auto ?? {}">
      <fluent-control-outlet [control]="control" [schema]="schema" [model]="model"></fluent-control-outlet>
    </nz-form-control>
  </nz-form-item>
</ng-template>

<ng-template #stepsTemplate let-schema="schema" let-control="control" let-model="model">
  <nz-steps
    #cmp
    [fluentBinder]="cmp"
    [fluentBinderSchema]="schema"
    [ngClass]="schema.class"
    [ngStyle]="schema.style"
    [nzType]="schema.type"
    [nzCurrent]="schema.active ?? 0"
    [nzLabelPlacement]="schema.placement"
    [nzProgressDot]="schema.dot"
    [nzSize]="schema.size"
    [nzStatus]="schema.status ?? 'process'"
    [nzStartIndex]="schema.start ?? 0"
    (nzIndexChange)="schema.active = $event">
    <nz-step
      #cmp
      *ngFor="let subschema of schema.schemas; index as index"
      [fluentBinder]="cmp"
      [fluentBinderSchema]="subschema"
      [ngClass]="subschema.class"
      [ngStyle]="subschema.style"
      [nzTitle]="subschema.title"
      [nzSubtitle]="subschema.subtitle"
      [nzDescription]="subschema.description"
      [nzDisabled]="subschema.disabled | call: model:subschema:control"
      [nzStatus]="subschema.status ?? schema.active === index ? 'process' : 'wait'"></nz-step>
  </nz-steps>

  <div
    *ngFor="let stepSchema of schema.schemas; index as stepIndex"
    nz-row
    [nzGutter]="gutter"
    [hidden]="schema.active !== stepIndex"
    [style.margin-top.px]="16">
    <ng-template #formColTemplate let-schema="schema" let-control="control" let-model="model">
      <div
        nz-col
        [nzSpan]="(schema.col | typeof: 'number') ? schema.col : schema.col?.span"
        [nzOffset]="schema.col?.offset"
        [nzFlex]="schema.col?.flex"
        [hidden]="schema.hidden | call: model:schema:control">
        <ng-container
          fluentWithInjector
          [ngTemplateOutlet]="formColContentTemplate"
          [ngTemplateOutletContext]="{ control: control, schema: schema, model: model }">
        </ng-container>
      </div>
    </ng-template>

    <ng-container
      *ngFor="let subschema of stepSchema.schemas"
      [ngTemplateOutlet]="formColTemplate"
      [ngTemplateOutletContext]="{ control: (subschema.name | control: form), schema: subschema, model: model }">
    </ng-container>
  </div>
</ng-template>

<ng-template #tabsTemplate let-schema="schema" let-control="control" let-model="model">
  <nz-tabset
    #cmp
    [fluentBinder]="cmp"
    [fluentBinderSchema]="schema"
    [ngClass]="schema.class"
    [ngStyle]="schema.style"
    [nzSelectedIndex]="schema.active"
    [nzType]="schema.type ?? 'line'"
    [nzSize]="schema.size ?? 'default'"
    [nzAnimated]="schema.animate ?? schema.type !== 'card'"
    [nzTabPosition]="schema.position ?? 'top'"
    [nzTabBarGutter]="schema.gutter"
    [nzCentered]="schema.center">
    <nz-tab
      #cmp
      *ngFor="let tabSchema of schema.schemas"
      [fluentBinder]="cmp"
      [fluentBinderSchema]="tabSchema"
      [ngClass]="tabSchema.class"
      [ngStyle]="tabSchema.style"
      [nzTitle]="tabSchema.title"
      [nzDisabled]="tabSchema.disabled | call: model:tabSchema:control">
      <div nz-row [nzGutter]="{ xs: 8, sm: 16, md: 24, lg: 32 }">
        <ng-template #formColTemplate let-schema="schema" let-control="control" let-model="model">
          <div
            nz-col
            [nzSpan]="(schema.col | typeof: 'number') ? schema.col : schema.col?.span"
            [nzOffset]="schema.col?.offset"
            [nzFlex]="schema.col?.flex"
            [hidden]="schema.hidden | call: model:schema:control">
            <ng-container
              fluentWithInjector
              [ngTemplateOutlet]="formColContentTemplate"
              [ngTemplateOutletContext]="{ control: control, schema: schema, model: model }">
            </ng-container>
          </div>
        </ng-template>

        <ng-container
          *ngFor="let subschema of tabSchema.schemas"
          [ngTemplateOutlet]="formColTemplate"
          [ngTemplateOutletContext]="{ control: (subschema.name | control: form), schema: subschema, model: model }">
        </ng-container>
      </div>
    </nz-tab>
  </nz-tabset>
</ng-template>
